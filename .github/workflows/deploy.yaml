name: Deploy

on:
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed

  workflow_dispatch:

jobs:
  deploy:
    # Only deploy if Tests workflow for a push to main succeeded
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main' }}

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            set -o pipefail

            APP_DIR="${VPS_APP_DIR:-$HOME/better-uptime}"
            cd "$APP_DIR"

            # ---------- Load Node / NVM ----------
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            fi

            # Ensure bashrc exists (pnpm installer expects it)
            [ -f "$HOME/.bashrc" ] || touch "$HOME/.bashrc"

            echo "Fetching latest code..."
            git fetch origin
            git checkout main
            git pull origin main

            # ---------- pnpm ----------
            echo "Ensuring pnpm is available..."
            if command -v corepack >/dev/null 2>&1; then
              corepack enable
              corepack prepare pnpm@9 --activate
            elif ! command -v pnpm >/dev/null 2>&1; then
              curl -fsSL https://get.pnpm.io/install.sh | sh -
              export PATH="$HOME/.local/share/pnpm:$PATH"
            fi

            # ---------- Bun ----------
            echo "Ensuring Bun is available..."
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"
            if ! command -v bun >/dev/null 2>&1; then
              curl -fsSL https://bun.sh/install | bash
            fi

            # ---------- Install ----------
            echo "Installing dependencies..."
            pnpm install --frozen-lockfile

            # ---------- Prisma ----------
            echo "Running Prisma migrations..."
            pnpm --filter @repo/store prisma:deploy

            echo "Generating Prisma Client..."
            pnpm --filter @repo/store prisma:generate

            # ---------- Build ----------
            echo "Building application..."
            pnpm build

            # ---------- PM2 ----------
            echo "Reloading PM2 processes..."
            pm2 reload ecosystem.config.cjs || pm2 start ecosystem.config.cjs
            pm2 save

            echo "Deployment completed successfully"
